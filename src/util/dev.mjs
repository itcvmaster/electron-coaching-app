import { hasMarkup } from "@/util/constants.mjs";
import globals from "@/util/global-whitelist.mjs";

export const IS_DEV = globals.location?.hostname === "localhost";

export const IS_NODE =
  typeof process !== "undefined" && typeof window === "undefined";

export const IS_NODE_HEADLESS = typeof process !== "undefined";

export const IS_APP = typeof __BLITZ__ !== "undefined";

const logo = `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSI+PG1hc2sgaWQ9ImMiIGZpbGw9IiNmZmYiPjxwYXRoIGQ9Ik0yNS44MDIgMTQuMDQ0di4xMDNjMCAuMDM0IDAgMCAwIDAtLjAxNi4xNzMtLjA3My4zNC0uMTY1LjQ4N2wtLjEyLjE1NS0uOTY3IDEuMjgxLTEyLjA1NiAxNS42NjYtLjA2OC4wODhhLjU1LjU1IDAgMCAxLS4zODYuMTZoLS44MjdjLS41ODIgMC0xLjE0LS4yMzItMS41NTItLjY0N2EyLjIyIDIuMjIgMCAwIDEtLjY0My0xLjU2M3YtLjI1NGwuOTM4LTguNzE2YS44MDIuODAyIDAgMCAwIDAtLjExMi41NS41NSAwIDAgMC0uMzM2LS41MS41MzguNTM4IDAgMCAwLS4yMS0uMDRIMS45MzJhLjU1LjU1IDAgMCAxLS4zODctLjE2MWwtLjkyOC0xLjA4Ni0uMDgyLS4wODhhMS4xMjUgMS4xMjUgMCAwIDEtLjI0Mi0uNjk2di0uMTAzYzAtLjAzNCAwIDAgMCAwIC4wMTYtLjE3My4wNzMtLjM0LjE2NS0uNDg3bC4xMi0uMTU1Ljk2Ny0xLjI4MUwxMy42My40MTlsLjA2OC0uMDg4YS41NDkuNTQ5IDAgMCAxIC4zODYtLjE2aC43ODRjLjU4MiAwIDEuMTQuMjMyIDEuNTUxLjY0Ny40MTIuNDE1LjY0My45NzcuNjQzIDEuNTYzdi4yNTRsLS45MzggOC43MTZhLjgwNS44MDUgMCAwIDAgMCAuMTEyLjU0OC41NDggMCAwIDAgLjMzNy41MS41NC41NCAwIDAgMCAuMjEuMDRoNy4zNzFjLjI5LjAzLjU1NS4xNzQuNzQuNGwuNzI1Ljg0Ny4wODIuMDg4Yy4xNDYuMjAyLjIyLjQ0Ny4yMTMuNjk2eiIvPjwvbWFzaz48cGF0aCBkPSJNMjguNzU0IDE0LjA0NHYuMTAzYzAgLjAzNCAwIDAgMCAwLS4wMTYuMTczLS4wNzMuMzQtLjE2NS40ODdsLS4xMi4xNTUtLjk2NyAxLjI4MS0xMi4wNTYgMTUuNjY2LS4wNjguMDg4YS41NS41NSAwIDAgMS0uMzg2LjE2aC0uODI3Yy0uNTgyIDAtMS4xNC0uMjMyLTEuNTUyLS42NDdhMi4yMiAyLjIyIDAgMCAxLS42NDMtMS41NjN2LS4yNTRsLjkzOC04LjcxNmEuODAyLjgwMiAwIDAgMCAwLS4xMTIuNTUuNTUgMCAwIDAtLjMzNi0uNTEuNTM4LjUzOCAwIDAgMC0uMjEtLjA0SDQuODg0YS41NS41NSAwIDAgMS0uMzg3LS4xNjFsLS45MjgtMS4wODYtLjA4Mi0uMDg4YTEuMTI1IDEuMTI1IDAgMCAxLS4yNDItLjY5NnYtLjEwM2MwLS4wMzQgMCAwIDAgMCAuMDE2LS4xNzMuMDczLS4zNC4xNjUtLjQ4N2wuMTItLjE1NS45NjctMS4yODFMMTYuNTgyLjQxOWwuMDY4LS4wODhhLjU0OS41NDkgMCAwIDEgLjM4Ni0uMTZoLjc4NGMuNTgyIDAgMS4xNC4yMzIgMS41NTEuNjQ3LjQxMi40MTUuNjQzLjk3Ny42NDMgMS41NjN2LjI1NGwtLjkzOCA4LjcxNmEuODA1LjgwNSAwIDAgMCAwIC4xMTIuNTQ4LjU0OCAwIDAgMCAuMzM3LjUxLjU0LjU0IDAgMCAwIC4yMS4wNGg3LjM3MWMuMjkuMDMuNTU1LjE3NC43NC40bC43MjUuODQ3LjA4Mi4wODhjLjE0Ni4yMDIuMjIuNDQ3LjIxMy42OTZ6IiBmaWxsPSJ1cmwoI2EpIiBzdHlsZT0iZmlsbDp1cmwoI2EpIi8+PHBhdGggZD0iTTI1LjgwMiAxNC4xNDdoNkwxOS44MjUgMTMuNmw1Ljk3Ni41NDd6bS0uMTY1LjQ4NyA0Ljc0MiAzLjY3Ni4xODItLjIzNS4xNTktLjI1M3ptLS4xMi4xNTUtNC43NDItMy42NzYtLjAyNC4wMy0uMDI0LjAzMnptLS45NjcgMS4yODEgNC43NTUgMy42Ni4wMTctLjAyMy4wMTYtLjAyMnpNMTIuNDk0IDMxLjczNmw0Ljc1IDMuNjY1LjAwNS0uMDA2em0tLjA2OC4wODggNC4yMzggNC4yNDcuMjc1LS4yNzQuMjM4LS4zMDgtNC43NS0zLjY2NXptLS4zODYuMTZ2NmguMDExem0tLjgyNyAwdi02ek05LjAyIDI5LjUybC01Ljk2Ni0uNjQxLS4wMzQuMzJ2LjMyMXptLjkzNy04LjcxNiA1Ljk2Ni42NDEuMDEyLS4xMTIuMDA4LS4xMTJ6bTAtLjExMi02LS4wNTQtLjAwMi4yMzYuMDE3LjIzNXptLS41NDYtLjU1djZoLjAyN2wuMDI3LS4wMDEtLjA1NC02em0tNy40NzggMC0uMDExIDZoLjAxMXptLS4zODctLjE2MS00LjU2IDMuODk4LjE1NC4xOC4xNjkuMTd6bS0uOTI4LTEuMDg2IDQuNTYyLTMuODk4LS4wOS0uMTA2LS4wOTYtLjEwMnptLS4wODItLjA4OC00LjcwOSAzLjcxOC4xNTkuMjAxLjE3NS4xODd6bS0uMjQyLS42OTZoLTZ2LjAwNHptMC0uMTAzaC02bDExLjk3Ni41NDd6bS4xNjUtLjQ4Ny00Ljc0Mi0zLjY3Ny0uMTgyLjIzNi0uMTU5LjI1M0wuNDU4IDE3LjUyem0uMTItLjE1NSA0Ljc0MiAzLjY3Ni4wMjQtLjAzLjAyNC0uMDMyem0uOTY3LTEuMjgxLTQuNzUtMy42NjUtLjAyLjAyNS0uMDE4LjAyNXpNMTMuNjMuNDE5IDguODgtMy4yNDYgMTMuNjMuNDJ6bS4wNjgtLjA4OEw5LjQ2LTMuOTE2bC0uMjc2LjI3NC0uMjM3LjMwOCA0Ljc1IDMuNjY1em0uMzg2LS4xNnYtNmgtLjAxMXptLjc4NCAwdi02em0yLjE5NCAyLjQ2NCA1Ljk2Ni42NDEuMDM0LS4zMnYtLjMyMXptLS45MzggOC43MTYtNS45NjUtLjY0Mi0uMDEyLjExMi0uMDA4LjExM3ptMCAuMTEyIDYgLjA1NC4wMDItLjIzNi0uMDE2LS4yMzV6bS41NDcuNTV2LTZoLS4wNTV6bTcuMzcxIDAgLjYxMi01Ljk2OC0uMzA1LS4wMzFoLS4zMDd2NnptLjc0LjQtNC42NDggMy43OTQuMDQ0LjA1NC4wNDUuMDUzem0uNzI1Ljg0Ny00LjU2IDMuOTAxLjA4OS4xMDMuMDkyLjA5OXptLjA4Mi4wODggNC44NjEtMy41MTctLjIyMy0uMzA4LS4yNi0uMjc4em0tNS43ODcuNjk2di4xMDNoMTJ2LS4xMDN6bTAgLjEwM3YuMDE1aDEydi0uMDE2aC0xMnYuMDE2aDEydi0uMDE2aC0xMnptLjAyNC0uNTQ3Yy4wNy0uNzYyLjMxOC0xLjUuNzI5LTIuMTU1bDEwLjE2NSA2LjM3N2E3LjEwNSA3LjEwNSAwIDAgMCAxLjA1Ni0zLjEyOXptMS4wNy0yLjY0My0uMTIxLjE1NSA5LjQ4MyA3LjM1NC4xMi0uMTU2em0tLjE2OS4yMTgtLjk2NiAxLjI4IDkuNTc3IDcuMjMuOTY3LTEuMjh6bS0uOTMyIDEuMjM2TDcuNzM5IDI4LjA3N2w5LjUxIDcuMzE4TDI5LjMwNSAxOS43M2wtOS41MS03LjMxOHpNNy43NDMgMjguMDcxbC0uMDY3LjA4OCA5LjUwMSA3LjMzLjA2OC0uMDg4em0uNDQ2LS40OTVhNS40NTEgNS40NTEgMCAwIDEgMy44MzktMS41OTFsLjAyMyAxMmE2LjU0OSA2LjU0OSAwIDAgMCA0LjYxMy0xLjkxNEw4LjE5IDI3LjU3NnptMy44NS0xLjU5MWgtLjgyNnYxMmguODI3di0xMnptLS44MjYgMGMxLjAyNCAwIDEuOTk3LjQxIDIuNzA3IDEuMTI1bC04LjUxNyA4LjQ1NGE4LjE4NyA4LjE4NyAwIDAgMCA1LjgxIDIuNDJ2LTEyem0yLjcwNyAxLjEyNWEzLjc4IDMuNzggMCAwIDEgMS4wOTggMi42NjRoLTEyYTguMjIgOC4yMiAwIDAgMCAyLjM4NSA1Ljc5em0xLjA5OCAyLjY2NHYtLjIwNGgtMTJ2LjIwNHptMC0uMjA1di0uMDQ1aC0xMiAxMnYtLjAwNGgtMTJ2LjAwM2gxMi0xMnYuMDQ3aDEyem0tLjAzNC41OTMuOTM4LTguNzE3TDMuOTkgMjAuMTYybC0uOTM4IDguNzE3IDExLjkzMSAxLjI4M3ptLjk1OC04Ljk0YTYuODA3IDYuODA3IDAgMCAwIDAtLjk0OGwtMTEuOTcxLjgzNWE1LjE5MyA1LjE5MyAwIDAgMSAwLS43MjNsMTEuOTcuODM1em0uMDE0LS40NzdhNi41NSA2LjU1IDAgMCAwLS40OC0yLjUyMmwtMTEuMTIgNC41MTRhNS40NSA1LjQ1IDAgMCAxLS40LTIuMDk5em0tLjQ4LTIuNTIyYTYuNTQ1IDYuNTQ1IDAgMCAwLTEuNDItMi4xNDlMNS41NCAyNC41MjhhNS40NTUgNS40NTUgMCAwIDEtMS4xODItMS43OTF6bS0xLjQyLTIuMTQ5YTYuNTQgNi41NCAwIDAgMC0yLjE1LTEuNDRMNy4zMzQgMjUuNzNhNS40NTggNS40NTggMCAwIDEtMS43OTUtMS4yMDFsOC41MTctOC40NTR6bS0yLjE1LTEuNDRhNi41MzcgNi41MzcgMCAwIDAtMi41NS0uNDkybC4xMDggMTEuOTk5YTUuNDYxIDUuNDYxIDAgMCAxLTIuMTMtLjQxMnptLTIuNDk2LS40OTNIMS45MzJ2MTJIOS40MXptLTcuNDY2IDBhNS40NSA1LjQ1IDAgMCAxIDMuODQgMS41OTJsLTguNDc2IDguNDk1YTYuNTUgNi41NSAwIDAgMCA0LjYxMyAxLjkxM3ptNC4xNjMgMS45NDEtLjkyOC0xLjA4NS05LjEyMyA3Ljc5Ni45MjggMS4wODZ6TTQuOTkzIDE0Ljc5bC0uMDgyLS4wODgtOC43NTEgOC4yMTIuMDgyLjA4NyA4Ljc1LTguMjExem0uMjUxLjNhNC44NzUgNC44NzUgMCAwIDEgMS4wNSAzLjAxN2wtMTIgLjAxYTcuMTI1IDcuMTI1IDAgMCAwIDEuNTMyIDQuNDF6bTEuMDUgMy4wMjJ2LS4xMDRoLTEydi4xMDJoMTJ6bTAtLjEwM3YtLjAxNmgtMTJ2LjAxNmgxMnYtLjAxNmgtMTJ2LjAxNnptLS4wMjUuNTQ3YTQuODk1IDQuODk1IDAgMCAxLS43MjggMi4xNTVsLTEwLjE2Ni02LjM3N2E3LjEwNiA3LjEwNiAwIDAgMC0xLjA1NyAzLjEyOWwxMS45NSAxLjA5M3ptLTEuMDcgMi42NDMuMTIxLS4xNTYtOS40ODMtNy4zNTMtLjEyLjE1NXptLjE2OS0uMjE4Ljk2Ni0xLjI4LTkuNTc3LTcuMjMtLjk2NyAxLjI4em0uOTI4LTEuMjNMMTguMzgxIDQuMDgzIDguODc5LTMuMjQ2LTMuMjA1IDEyLjQybDkuNTAxIDcuMzN6TTE4LjM4MSA0LjA4NGwuMDY3LS4wODgtOS41MDEtNy4zMy0uMDY4LjA4OHptLS40NDYuNDk1YTUuNDUxIDUuNDUxIDAgMCAxLTMuODQgMS41OTFsLS4wMjItMTJBNi41NDkgNi41NDkgMCAwIDAgOS40Ni0zLjkxNnptLTMuODUgMS41OTFoLjc4MnYtMTJoLS43ODN2MTJ6bS43ODIgMGEzLjgxNCAzLjgxNCAwIDAgMS0yLjcwNi0xLjEyNWw4LjUxNi04LjQ1NGE4LjE4NiA4LjE4NiAwIDAgMC01LjgxLTIuNDJ2MTJ6bS0yLjcwNi0xLjEyNWEzLjc4IDMuNzggMCAwIDEtMS4wOTktMi42NjRoMTJhOC4yMiA4LjIyIDAgMCAwLTIuMzg1LTUuNzl6TTExLjA2MiAyLjM4di4yMDZoMTJ2LS4yMDVoLTEyem0wIC4yMDV2LjA0NWgxMi0xMnYuMDA0aDEyVjIuNjNoLTEyIDEydi0uMDQ1em0uMDM1LS41OTMtLjkzOCA4LjcxNiAxMS45MyAxLjI4NC45MzktOC43MTd6bS0uOTU4IDguOTRhNi44MDcgNi44MDcgMCAwIDAgMCAuOTQ4bDExLjk3LS44MzVjLjAxNy4yNC4wMTcuNDgyIDAgLjcyM2wtMTEuOTctLjgzNXptLS4wMTUuNDc3YTYuNTUgNi41NSAwIDAgMCAuNDgxIDIuNTIybDExLjExOS00LjUxNGE1LjQ1IDUuNDUgMCAwIDEgLjQgMi4wOTl6bS40ODEgMi41MjJjLjMyNS44LjgwNiAxLjUzIDEuNDIgMi4xNDlsOC41MTYtOC40NTRhNS40NTQgNS40NTQgMCAwIDEgMS4xODMgMS43OXptMS40MiAyLjE0OWE2LjUzOSA2LjUzOSAwIDAgMCAyLjE1IDEuNDRsNC41NzEtMTEuMDk2YTUuNDYgNS40NiAwIDAgMSAxLjc5NSAxLjIwMmwtOC41MTcgOC40NTR6bTIuMTUgMS40NGMuODA4LjMzMyAxLjY3NS41IDIuNTUuNDkybC0uMTA5LTEyYTUuNDYyIDUuNDYyIDAgMCAxIDIuMTMuNDEzem0yLjQ5NS40OTNoNy4zNzJ2LTEySDE2LjY3em02Ljc2LS4wMzJhNC45IDQuOSAwIDAgMS0zLjI5Ni0xLjc3NUwyOS40MyA4LjYyYTcuMSA3LjEgMCAwIDAtNC43NzYtMi41NzRMMjMuNDMgMTcuOTgyem0tMy4yMDctMS42NjguNzI1Ljg0NyA5LjExNy03LjgwMi0uNzI1LS44NDd6bS45MDUgMS4wNDkuMDgzLjA4OCA4Ljc1Ni04LjIwNi0uMDgyLS4wODd6bS0uNC0uNDk4YTQuODc1IDQuODc1IDAgMCAxLS45MjMtMy4wMTZsMTEuOTkzLjM5QTcuMTI2IDcuMTI2IDAgMCAwIDMwLjQ1IDkuODNsLTkuNzIzIDcuMDM0eiIgZmlsbD0idXJsKCNiKSIgbWFzaz0idXJsKCNjKSIgc3R5bGU9ImZpbGw6dXJsKCNiKSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMi45NTIpIi8+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMjEuNjQ2IiB5MT0iMjAuNDQ4IiB4Mj0iNi44ODYiIHkyPSI4LjA1MiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGdyYWRpZW50VHJhbnNmb3JtPSJ0cmFuc2xhdGUoMi45NTIpIj48c3RvcCBzdG9wLWNvbG9yPSIjQ0UwRjUwIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjRkUxMTJEIi8+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImIiIHgxPSIxMy4wNDgiIHkxPSIuMTciIHgyPSIxMy4wNDgiIHkyPSIzMS45ODUiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj48c3RvcCBzdG9wLWNvbG9yPSIjRkYwMDNEIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjRkYwMDNEIiBzdG9wLW9wYWNpdHk9IjAiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48L3N2Zz4=`;

const cssLabel = `
  color: #dd364d;
  font-size: 15px;
  background: url(${logo}) left center no-repeat;
  background-size: auto 18px;
`;
const cssText = (method) => `
  color: ${(() => {
    switch (method) {
      case "warn":
        return "#ffcf21";
      case "error":
        return "#ff311f";
      case "debug":
        return "#965d36";
      default:
        return "#4191ab";
    }
  })()};
  ${method === "warn" ? "font-size: 20px;" : ""}
`;
function devConsole(method) {
  return function dev() {
    if (!IS_DEV) return;
    const args = Array.prototype.slice.call(arguments);
    const [primitives, objs] = args.reduce(
      (a, _) => {
        a[_ === Object(_) ? 1 : 0].push(_);
        return a;
      },
      [[], []]
    );
    const c = console;
    c[method](
      `%c  %c ${primitives.join(" ")}`,
      cssLabel,
      cssText(method),
      ...objs
    );
  };
}

export const devLog = devConsole("log");
export const devWarn = devConsole("warn");
export const devError = devConsole("error");
export const devDebug = devConsole("debug");

export const devRefs = {};

// Make unhandled promise rejections big and ugly.
if (!IS_NODE) {
  globals.addEventListener("unhandledrejection", (event) => {
    devWarn("UNHANDLED PROMISE REJECTION!", event.reason);
    if (IS_DEV) event.preventDefault();
  });
}

if (IS_DEV) {
  window.__BLITZ_DEV__ = globals.__BLITZ_DEV__; // eslint-disable-line no-restricted-properties
}

if (IS_DEV && !hasMarkup) {
  const eventSource = new EventSource("/dev-events");
  let didOpen = false;

  eventSource.addEventListener("message", (event) => {
    const changes = JSON.parse(event.data);
    const update = changes.find(({ type }) => type === "update");
    if (update) {
      /* eslint-disable no-undef */
      if (__BLITZ_RELOAD__) {
        /* eslint-enable no-undef */
        devLog(`Reloading due to update in "${update.path}"!`);
        globals.location.reload();
      }
    }
  });

  eventSource.addEventListener("open", () => {
    didOpen = true;
  });

  eventSource.addEventListener("error", () => {
    eventSource.close();
    if (!didOpen) return;
    devRefs.appRefs.ContentWrapper = () => {
      const error = new Error(
        "The dev server has stopped running. Please refresh the browser when it has restarted."
      );
      error.name = "Dev server has stopped 🤡";
      throw error;
    };
    devRefs.appRefs.forceRender();
  });
}
